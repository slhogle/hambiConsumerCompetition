---
title: "Fig. 3"
output:
  github_document:
    toc: yes
    toc_depth: 2
    fig_width: 7
    fig_height: 5
    dev: svg
    keep_html: yes
    html_preview: yes
---

```{r}
library(tidyverse)
library(here)
library(rcartocolor)
library(RcppRoll)
library(patchwork)
library(scales)
library(ggforce)
library(mcp)
library(rjags)
library(vegan)

`%nin%` = Negate(`%in%`)
```

# LOAD DATA
```{r}
predator <- read_tsv(here("data", "predator_density.tsv"), col_types="ccccdddd") %>%
  mutate(replicate=factor(replicate, levels=c("A", "B", "C", "D"))) %>%
  mutate(treatment=factor(treatment, levels=c("H", "HN", "HPanc", "HPevo", "HNPanc", "HNPevo")),
         microcosmID=factor(microcosmID))

counts <- read_tsv(here::here("data", "norm_counts.tsv"))

div.sum <- readRDS(here::here("data", "diversity_summary.rds"))
dvcov <- readRDS(here::here("data", "divnet_out.rds"))
```
# PLOT BRAY CURTIS
```{r}
dvbc <- data.frame(dvcov$`bray-curtis`) %>% 
  rownames_to_column(var="sampleA") %>%
  pivot_longer(-sampleA, names_to="sampleB", values_to="mean") %>%
  mutate(sampleA=str_replace_all(sampleA, "_|-", "."),
         sampleB=str_replace_all(sampleB, "_|-", ".")) %>%
  mutate(day=case_when(str_detect(sampleA, "d0") & str_detect(sampleB, "d0") ~ 0,
                       str_detect(sampleA, "d5") & str_detect(sampleB, "d5") ~ 5,
                       str_detect(sampleA, "d9") & str_detect(sampleB, "d9") ~ 9,
                       str_detect(sampleA, "d13") & str_detect(sampleB, "d13") ~ 13,
                       str_detect(sampleA, "d17") & str_detect(sampleB, "d17") ~ 17,
                       str_detect(sampleA, "d21") & str_detect(sampleB, "d21") ~ 21,
                       str_detect(sampleA, "d29") & str_detect(sampleB, "d29") ~ 29,
                       str_detect(sampleA, "d45") & str_detect(sampleB, "d45") ~ 45,
                       str_detect(sampleA, "d61") & str_detect(sampleB, "d61") ~ 61,
                       TRUE ~ NA_real_)) %>% drop_na() %>% 
  mutate(sampleA=str_replace_all(sampleA, "\\d\\.d\\d+", "")) %>%
  mutate(sampleB=str_replace_all(sampleB, "\\d\\.d\\d+", "")) %>%
  distinct() %>%
  mutate(sampleA=factor(sampleA, levels=rev(c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo")))) %>%
  mutate(sampleB=factor(sampleB, levels=rev(c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo")))) %>%
  arrange(sampleA, sampleB) %>%
  group_by(grp = paste0(pmin(as.character(sampleA), as.character(sampleB)),
                        pmax(as.character(sampleA), as.character(sampleB)), 
                        as.character(day))) %>%
  slice(1) %>%
  ungroup() %>% 
  select(-grp) %>%
  mutate(sampleA=factor(sampleA, levels=rev(c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo")))) %>%
  mutate(sampleB=factor(sampleB, levels=rev(c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo"))))
  
dvbc_var <- data.frame(dvcov$`bray-curtis-variance`) %>% 
  rownames_to_column(var="sampleA") %>%
  pivot_longer(-sampleA, names_to="sampleB", values_to="variance") %>%
  mutate(sampleA=str_replace_all(sampleA, "_|-", "."),
         sampleB=str_replace_all(sampleB, "_|-", ".")) %>%
  mutate(day=case_when(str_detect(sampleA, "d0") & str_detect(sampleB, "d0") ~ 0,
                       str_detect(sampleA, "d5") & str_detect(sampleB, "d5") ~ 5,
                       str_detect(sampleA, "d9") & str_detect(sampleB, "d9") ~ 9,
                       str_detect(sampleA, "d13") & str_detect(sampleB, "d13") ~ 13,
                       str_detect(sampleA, "d17") & str_detect(sampleB, "d17") ~ 17,
                       str_detect(sampleA, "d21") & str_detect(sampleB, "d21") ~ 21,
                       str_detect(sampleA, "d29") & str_detect(sampleB, "d29") ~ 29,
                       str_detect(sampleA, "d45") & str_detect(sampleB, "d45") ~ 45,
                       str_detect(sampleA, "d61") & str_detect(sampleB, "d61") ~ 61,
                       TRUE ~ NA_real_)) %>% drop_na() %>% 
  mutate(sampleA=str_replace_all(sampleA, "\\d\\.d\\d+", "")) %>%
  mutate(sampleB=str_replace_all(sampleB, "\\d\\.d\\d+", "")) %>%
  distinct() %>%
  mutate(sampleA=factor(sampleA, levels=rev(c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo")))) %>%
  mutate(sampleB=factor(sampleB, levels=rev(c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo")))) %>%
  arrange(sampleA, sampleB) %>%
  group_by(grp = paste0(pmin(as.character(sampleA), as.character(sampleB)),
                        pmax(as.character(sampleA), as.character(sampleB)), 
                        as.character(day))) %>%
  slice(1) %>%
  ungroup() %>% 
  select(-grp) %>%
  mutate(sampleA=factor(sampleA, levels=rev(c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo")))) %>%
  mutate(sampleB=factor(sampleB, levels=rev(c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo"))))
```

```{r}
p0 <- dvbc %>% 
  filter(day != 0) %>%
  ggplot(aes(x=sampleA, y=sampleB, fill=mean)) + 
   geom_tile() + 
   facet_grid(~day) +
   scale_fill_viridis_c() + 
   coord_fixed()

p0
```

```{r}
dvbc.fmt <- dvbc %>% 
  arrange(sampleA, sampleB) %>%
  group_by(grp = paste0(pmin(as.character(sampleA), as.character(sampleB)),
                        pmax(as.character(sampleA), as.character(sampleB)), 
                        as.character(day))) %>%
  slice(1) %>%
  ungroup() %>% 
  select(-grp) #%>% 
  #filter(sampleA != sampleB) 

dvbc_var.fmt <- dvbc_var %>% 
  arrange(sampleA, sampleB) %>%
  group_by(grp = paste0(pmin(as.character(sampleA), as.character(sampleB)),
                        pmax(as.character(sampleA), as.character(sampleB)), 
                        as.character(day))) %>%
  slice(1) %>%
  ungroup() %>% 
  select(-grp) %>% 
  filter(sampleA != sampleB) 

thresh <- tibble::tribble(
  ~treatment, ~day,       ~event,
        "HN",  17, "stabilized",
     "HPanc",  20, "stabilized",
     "HPevo",  20, "stabilized",
    "HNPanc",  21, "stabilized",
    "HNPevo",  25, "stabilized",
    "HNPevo",  32,       "lost",
    "HNPanc",  11,       "lost"
  ) %>%
  mutate(event=factor(event))


p0 <- left_join(dvbc.fmt, dvbc_var.fmt) %>%
  ggplot(aes(x=day, y=mean, color=sampleB)) +
  geom_linerange(aes(ymin=mean-variance*10, ymax=mean+variance*10)) +
  geom_point() + 
  geom_line() +
  #geom_vline(data=thresh, aes(xintercept=day, linetype=event)) + 
  facet_grid(sampleA~sampleB) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

p0
```


# REPLICATE REPEATABILITY/DISSIMILARITY
```{r}
Dq1 <- function(.data){
  pseudocount <- 1e-7
  M <- dim(.data)[1]
  species_freq <- apply(.data, 1, function(x) as.numeric(x)/sum(x))
  species_freq[species_freq == 0] <- pseudocount
  species_freq_pool <- as.numeric(colSums(.data)/sum(.data))
  species_freq_pool[species_freq_pool == 0] <- pseudocount
  Meff <- exp(sum(apply(species_freq, 2, 
                        function(x) sum(x*log(x/species_freq_pool), na.rm=TRUE)))/M)
  Diss <- (Meff - 1)/(M-1)
  return(Diss)
}
```

Get a list of data frames that contain only species counts in columns. only integers
```{r}
reps.list <- counts %>%
  select(sample, treatment, day, replicate, strainID, count.correct) %>%
  pivot_wider(names_from="strainID", values_from="count.correct") %>%
  group_by(day, treatment) %>%
  group_split() %>%
  map(., . %>% select(5:28))

reps.list.names <- counts %>%
  select(sample, treatment, day, replicate, strainID, count.correct) %>%
  pivot_wider(names_from="strainID", values_from="count.correct") %>%
  group_by(day, treatment) %>%
  group_keys() %>%
  unite("ID", day:treatment, sep="_") %>% pull(ID)

names(reps.list) <- reps.list.names
```

Calculate dissimilarities
```{r}
Dq1.res <- map_df(reps.list, Dq1) %>%
  pivot_longer(cols=everything(), names_to="sample", values_to = "shannon_div")
```

Randomly shuffle species occurences across treatments and replicates
```{r}
df1 <- counts %>%
  select(sample, treatment, day, replicate, strainID, count.correct) %>%
  pivot_wider(names_from="strainID", values_from="count.correct") %>%
  select(5:28)

reps.r.list <- list()

for (i in 1:54){
  reps.r.list[[i]] <- sample_n(df1, 4)
}

names(reps.r.list) <- reps.list.names
```

Calculate dissimilarities expected if you randomly shuffled the species distributions
```{r}
Dq1.res.rand <- map_df(reps.r.list, Dq1) %>%
  pivot_longer(cols=everything(), names_to="sample", values_to = "shannon_div_rand")
```

```{r}
dq1.f <- left_join(Dq1.res.rand, Dq1.res) %>%
  pivot_longer(cols=-sample, names_to="index") %>%
  mutate(index=factor(index, levels=c("shannon_div_rand", "shannon_div")))

p1 <- ggplot(dq1.f, aes(x=index)) + 
  geom_boxplot(aes(y=value)) +
  labs(x="", y="D'") + 
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

p1
```

# SPECIES ABUNDANCE DISTRIBUTION

## FOR ORDERING STRAINS BY ABUNDANCE
```{r}
strainrecode <- counts %>%
  filter(day > 0) %>%
  group_by(treatment, day, replicate, strainID) %>%
  summarize(spsum=sum(count.correct)) %>%
  ungroup() %>%
  group_by(treatment, day, replicate) %>%
  mutate(nreads=sum(spsum)) %>%
  ungroup() %>%
  mutate(RA=round(spsum/nreads, 2)) %>%
  group_by(strainID) %>%
  summarize(mRA=mean(RA), sdRA=sd(RA)) %>%
  ungroup() %>%
  arrange(mRA) %>%
  distinct(strainID) %>%
  rowid_to_column("strain.num")
  
strainrecode <- counts %>% 
  group_by(strainID) %>%
  summarize(spsum=sum(count.correct)) %>%
  ungroup() %>%
  mutate(RA=spsum/sum(spsum)) %>%
  arrange(desc(RA)) %>%
  distinct(strainID) %>%
  rowid_to_column("strain.num")
```

Setup tibble
```{r}
sad <- counts %>%
  mutate(count.correct=ifelse(count.correct==0, 1, count.correct)) %>%
  filter(day > 0) %>%
  group_by(treatment, day, replicate, strainID) %>%
  summarize(spsum=sum(count.correct)) %>%
  ungroup() %>%
  group_by(treatment, day, replicate) %>%
  mutate(nreads=sum(spsum)) %>%
  ungroup() %>%
  mutate(RA=round(spsum/nreads, 2)) %>%
  group_by(treatment, strainID) %>%
  summarize(mRA=mean(RA), sdRA=sd(RA)) %>%
  mutate(mRA=ifelse(mRA < 1e-4, 1e-4, mRA)) %>%
  ungroup() %>%
  mutate(ymin=mRA-sdRA, ymax=mRA+sdRA) %>%
  mutate(ymin=ifelse(ymin<=0, 1e-4, ymin)) %>%
  left_join(., strainrecode) %>%
  mutate(treatment=factor(treatment, levels=c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo")))
```

plot
```{r}
p2 <- ggplot(sad) + 
  geom_linerange(aes(x=strain.num, ymin = ymin, ymax = ymax), color="grey80") + 
  geom_point(aes(x=strain.num, y=mRA), size=0.5) + 
  facet_grid(~ treatment) +
  labs(y="", x="") +
  #coord_flip() + 
  #scale_y_continuous(trans = trans_reverser('log'), breaks=c(0.5, 0.1, 0.01)) +
  scale_y_continuous(trans = 'log10',
                       breaks = c(1, 0.5, 0.1, 0.01, 0.001),
                       labels = label_percent(accuracy = 0.1)) + 
  # scale_y_continuous(trans = scales::pseudo_log_trans(sigma = 1e-4, base = 10),
  #                      breaks = c(1, 0.5, 0.1, 0.01, 0.001),
  #                      labels = label_percent(accuracy = 0.1)) + 
  scale_x_continuous(n.breaks=24, limits = c(0,25), expand=c(0,0)) + 
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

p2
```

# HEAT MAPS
```{r}
my_colors <- carto_pal(6, "Vivid")

names(my_colors) <- c("HPanc", "HPevo", "HN", "HNPanc", "HNPevo", "H")

my_colors
```

Calculate means over replicates
```{r}
hmapdf.mn <- counts %>% 
  mutate(count=exp(rlogcount)) %>%
  dplyr::select(-lograrecount, -log10rab, -sflogcount, -rlogcount, -PA) %>%
  arrange(strainID, microcosmID, day) %>%
  group_by(treatment, strainID, day) %>%
  mutate(count.mean=mean(count)) %>% ungroup() %>%
  dplyr::select(day, treatment, cil, wrm, strainID, count.mean) %>%
  distinct() %>%
  group_by(treatment, strainID) %>%
  mutate(count.mean.f=count.mean/max(count.mean)) %>%
  mutate(count.mean.f1=log(count.mean/max(count.mean))/sqrt(2)) %>%
  mutate(xmin=day, xmax=lead(day)) %>%
  mutate(xmax=ifelse(is.na(xmax), 65, xmax)) %>%
  ungroup() %>%
  left_join(., strainrecode) %>%
  mutate(treatment=factor(treatment, levels=c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo")))
```

```{r}
p3 <- ggplot(hmapdf.mn) +
  geom_rect(aes(ymin=xmin, ymax=xmax, xmin = strain.num-0.5, 
                xmax = strain.num+0.5, fill = count.mean.f)) +
  geom_hline(yintercept=32) +
  geom_hline(yintercept=11) +
  scale_fill_viridis_c(option = "C", begin = 0.05, end=0.95, direction =-1,
                       trans = scales::pseudo_log_trans(sigma = 1e-3, base = exp(1)),
                       breaks = breaks_log(n = 5, base = 10),
                       labels = label_percent(accuracy = 0.1)) +
  facet_grid(~ treatment) +
  labs(y="", x="") +
  scale_x_continuous(n.breaks=24, limits = c(0,25), expand=c(0,0)) + 
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

p3
```

# ORDINATION
```{r}
a <- counts %>%
  filter(day != 0) %>%
  #filter(day < 22) %>%
  select(sample, strainID, count.correct) %>%
  #mutate(count.correct=ifelse(count.correct==0, 1, count.correct)) %>%
  group_by(sample) %>%
  mutate(count.correct=count.correct/sum(count.correct)) %>%
  ungroup() %>%
  pivot_wider(names_from="strainID", values_from="count.correct") %>%
  column_to_rownames(var="sample") %>%
  data.frame()

# Bray-curtis dissimilarity 
dist <- vegdist(a,  method = "bray")        

nmds_ord <- metaMDS(dist, k = 2, trymax = 100, trace = F, autotransform = FALSE)

nmds2plot <- data.frame(nmds_ord$points) %>%
  rownames_to_column(var="sample") %>%
  left_join(., distinct(select(counts, sample:wrm))) %>%
  mutate(method="NMDS") %>%
  dplyr::rename(axis_1 = MDS1, axis_2 = MDS2) %>%
  mutate(treatment=factor(treatment, levels=c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo")))

centroids <- nmds2plot %>% 
  group_by(treatment, day) %>%
  dplyr::mutate(NMDS1=mean(axis_1), NMDS2=mean(axis_2),
                NMDS1sd=sd(axis_1), NMDS2sd=sd(axis_2)) %>%
  ungroup() %>%
  mutate(treatment=factor(treatment, levels=c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo")))

spiders <- nmds2plot %>% 
  select(sample, fromx=axis_1, fromy=axis_2) %>%
  left_join(., centroids) %>%
  dplyr::rename(tox=NMDS1, toy=NMDS2) %>%
  mutate(treatment=factor(treatment, levels=c("H", "HPanc", "HPevo", "HN", "HNPanc", "HNPevo")))

p4 <- ggplot() + 
  geom_point(data=nmds2plot, aes(x=axis_1, y=axis_2, color=factor(day)), size=0.5) +
  geom_segment(data = spiders, aes(x=fromx, xend = tox, 
                               y=fromy, yend = toy, group=treatment, color=factor(day))) +
  geom_link2(data = centroids, aes(x=NMDS1, y=NMDS2, group=microcosmID, color=factor(day))) +
  geom_point(data = centroids, aes(x=NMDS1, y=NMDS2, fill=factor(day), size=((NMDS1sd+NMDS2sd)/2)^-1), shape=21) +
  facet_grid(~treatment) + 
  scale_color_brewer(type="qual", palette="Paired") +
  scale_fill_brewer(type="qual", palette="Paired") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

p4
```

```{r}
library(cvequality)

t <- nmds2plot %>%
  #filter(day < 22) %>%
  #filter(day > 21) %>%
  arrange(treatment, replicate, day) %>%
  group_by(microcosmID) %>%
  mutate(axis1_lag = lag(axis_1),
         axis2_lag = lag(axis_2)) %>%
  mutate(d=sqrt((axis_1-axis1_lag)^2 + (axis_2-axis2_lag)^2)) %>%
  ungroup()


m <- glm(data=t, formula=d ~ treatment, family=gaussian())
m1 <- glm(data=t, formula=d ~ treatment, family=Gamma())
m2 <- glm(data=t, formula=d ~ treatment, family=inverse.gaussian())

tt <- t %>% select(d, treatment) %>% drop_na() %>% data.frame()
with(tt, asymptotic_test(d, treatment))
with(tt, mslr_test(nr = 1e4, d, treatment))
          
library(performance)

summary(m1)
check_model(m)

compare_performance(m, m1, m2, rank = TRUE)
```

```{r}
ggplot(t, aes(x=treatment, y=d, color=factor(day))) + 
  geom_point()
```

# COMBINED PLOT
```{r}
(p2 / p3 / p4) + plot_layout(guides = 'collect', 
                                     widths = c(1,1,1),
                                     heights= c(2,4,3),
                                     ncol=1)
``` 

```{r}

```






# CHANGE POINT REGRESSION
```{r}
dpsegin <- div.sum %>% 
  filter(inference=="plugin")
```

```{r}
model00 <- list(
 estimate ~ 1 + day, 
 estimate ~ 1 + (1|treatment) ~ 0  
)
```

```{r}
fit00 <- mcp(model00, data = dpsegin, sample = "both", iter = 10000)
```

```{r}
mcpplotfinal <- plot(fit00, geom_data=F, facet_by="treatment", q_predict=TRUE)

thresh <- tibble::tribble(
  ~treatment, ~day,       ~event,
        "HN",  17, "stabilized",
     "HPanc",  20, "stabilized",
     "HPevo",  20, "stabilized",
    "HNPanc",  21, "stabilized",
    "HNPevo",  25, "stabilized",
    "HNPevo",  32,       "lost",
    "HNPanc",  11,       "lost"
  ) %>%
  mutate(event=factor(event))

dnplot <- filter(div.sum, inference=="divnet") %>%
  dplyr::select(day, treatment, estimate, lower, upper) %>%
  distinct()

p4 <- mcpplotfinal +
  facet_grid(treatment ~ .) +
  geom_pointrange(data=dnplot, 
                  aes(x=day, y=estimate,
                      ymin = lower, ymax = upper), fatten=1) + 
  geom_vline(data=thresh, aes(xintercept=day, linetype=event)) + 
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

p4
```




# FINAL PLOT FIGURE 3
```{r}
pfinal <- p2 + p3 + p4 + p1 + plot_layout(guides = 'collect', 
                                     widths = c(1, 2, 2, 1),
                                     heights= c(2,1),
                                     ncol=3) + 
  plot_annotation(tag_levels = 'A')

pfinal
```

```{r}
ggsave(here("figs", "diversity_abundance2.svg"), pfinal, width=20.8, height=17.8, units="cm",
       device="svg")
```
